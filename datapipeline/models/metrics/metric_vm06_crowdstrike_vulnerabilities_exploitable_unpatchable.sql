{{
    config(
        materialized="table",
        partition_by={
            "field": "upload_timestamp",
            "data_type": "datestamp",
            "granularity": "day",
        },
        tags=["metric", "crowdstrike"]
    )
}}

WITH unremediated_vulns AS (
    SELECT 
        v.agent_id,
        COUNT(*) AS vuln_count
    FROM {{ source('source','crowdstrike_vulnerabilities') }} v
    WHERE 
        v.has_patch IS FALSE AND
        v.has_exploit AND
        {{ days_to_today('v.published_on', 'CURRENT_DATE') }} > 0 AND
        v.status IN ('open', 'reopen')
    GROUP BY v.agent_id
)

SELECT 
    'VM06' AS metric_id,
    cs.serial_number AS resource,
    cs.upload_timestamp,
    
    CASE 
        WHEN uv.vuln_count IS NULL THEN 1
        ELSE 0
    END AS compliance,

    CASE 
        WHEN uv.vuln_count IS NULL THEN 'No critical updates found'
        ELSE 'Patch or upgrade your OS to remediate ' || uv.vuln_count || ' vulnerabilities.'
    END AS detail,

    {{ current_timestamp() }} AS etl_timestamp

FROM {{ source('source','crowdstrike_hosts') }} cs
LEFT JOIN unremediated_vulns uv 
    ON uv.agent_id = cs.device_id
WHERE
    cs.serial_number is not null AND
    {{ days_to_today('cs.last_seen','cs.upload_timestamp') }} < 7
